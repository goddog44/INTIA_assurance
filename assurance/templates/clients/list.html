{% extends 'base.html' %}

{% block title %}Gestion des Clients{% endblock %}

{% block content %}
<!-- Onglets -->
<div class="mb-6 border-b border-gray-300 dark:border-gray-700">
    <ul class="flex flex-wrap -mb-px">
        <li class="mr-2">
            <button class="tab-btn inline-block py-2 px-4 text-primary font-medium border-b-2 border-primary" data-tab="clients">Clients</button>
        </li>
        <li class="mr-2">
            <button class="tab-btn inline-block py-2 px-4 text-gray-500 dark:text-gray-400 hover:text-primary font-medium border-b-2 border-transparent hover:border-primary" data-tab="insurances">Assurances</button>
        </li>
    </ul>
</div>

<!-- Section Clients -->
<div id="clients-tab" class="tab-content">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Gestion des Clients</h2>
        <button id="addClientBtn" class="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90">Ajouter un Client</button>
    </div>
    
    <!-- Tableau des clients -->
    <div class="overflow-x-auto shadow-md rounded-lg">
        <table class="min-w-full bg-white dark:bg-gray-800">
            <thead class="bg-gray-100 dark:bg-gray-700">
                <tr>
                    <th class="py-3 px-4 text-left">Nom</th>
                    <th class="py-3 px-4 text-left">Prénom</th>
                    <th class="py-3 px-4 text-left">Email</th>
                    <th class="py-3 px-4 text-left">Téléphone</th>
                    <th class="py-3 px-4 text-left">Succursale</th>
                    <th class="py-3 px-4 text-center">Actions</th>
                </tr>
            </thead>
            <tbody id="clientsTableBody">
                {% for client in clients %}
                <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="py-3 px-4">{{ client.last_name }}</td>
                    <td class="py-3 px-4">{{ client.first_name }}</td>
                    <td class="py-3 px-4">{{ client.email }}</td>
                    <td class="py-3 px-4">{{ client.phone }}</td>
                    <td class="py-3 px-4">{{ client.branch.name }}</td>
                    <td class="py-3 px-4 text-center">
                        <button class="edit-client text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 mr-2" data-id="{{ client.id }}">
                            <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                        <button class="delete-client text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300" data-id="{{ client.id }}">
                            <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Section Assurances (chargée via AJAX) -->
<div id="insurances-tab" class="tab-content hidden"></div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Initialisation des onglets
    document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', function() {
            const tab = this.dataset.tab;
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${tab}-tab`).classList.remove('hidden');
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('text-primary', 'border-primary');
                btn.classList.add('text-gray-500', 'dark:text-gray-400', 'border-transparent');
            });
            this.classList.add('text-primary', 'border-primary');
            this.classList.remove('text-gray-500', 'dark:text-gray-400', 'border-transparent');
            
            // Chargement dynamique des assurances si nécessaire
            if (tab === 'insurances' && document.getElementById('insurances-tab').innerHTML === '') {
                fetch('{% url "insurances:list" %}')
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById('insurances-tab').innerHTML = html;
                    });
            }
        });
    });

    // Gestion des clients
    document.getElementById('addClientBtn').addEventListener('click', () => {
        fetch('{% url "clients:create" %}')
            .then(response => response.text())
            .then(html => {
                document.getElementById('clientModal').innerHTML = html;
                showModal('clientModal');
            });
    });

    document.querySelectorAll('.edit-client').forEach(button => {
        button.addEventListener('click', function() {
            const clientId = this.dataset.id;
            fetch(`/clients/${clientId}/edit/`)
                .then(response => response.text())
                .then(html => {
                    document.getElementById('clientModal').innerHTML = html;
                    showModal('clientModal');
                });
        });
    });
</script>
{% endblock %}